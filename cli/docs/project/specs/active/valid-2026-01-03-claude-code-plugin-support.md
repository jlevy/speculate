# Feature Validation: Claude Code Plugin Support

## Purpose

This validation spec documents the testing performed and manual validation needed for
the Claude Code plugin support feature in the Speculate CLI.

**Feature Plan:** [plan-2026-01-03-claude-code-plugin-support.md](plan-2026-01-03-claude-code-plugin-support.md)

**Research Brief:** [research-coding-agent-skills-commands-extensions.md](../../../../docs/general/research/current/research-coding-agent-skills-commands-extensions.md)

## Scope of This PR

This PR includes four components:

1. **v1 Core Implementation** âœ… Complete
   - Claude Code plugin generation (`speculate install`)
   - Plugin removal (`speculate uninstall`)
   - Status reporting (`speculate status`)
   - 22 unit/integration tests

2. **v1.1 Enhancements** âœ… Complete
   - Dynamic version sync from CLI version
   - README.md generation in plugin directory
   - Token budget documentation in SKILL.md
   - Repository/homepage metadata in plugin.json
   - 13 new tests for v1.1 features

3. **v2 Enhancements** âœ… Complete
   - SessionStart hook generation
   - `--global` flag for personal installation to `~/.claude/plugins/`
   - Agent-rules symlinks in reference/ directory
   - Global/project status reporting
   - 7 new tests for v2 features

4. **Research Documentation** âœ… Complete
   - Comprehensive research brief on coding agent extension mechanisms
   - Cross-platform comparison (Claude Code, Codex, Cursor, Windsurf)

## Stage 4: Validation Stage

## Validation Planning

The Claude Code plugin support feature adds the ability for `speculate install` to create
a Claude Code plugin at `.claude/plugins/speculate/` with symlinked commands and a
generated routing skill.

## Automated Validation (Testing Performed)

### Unit Testing

Added 42 new test cases in `cli/tests/test_cli_commands.py`:

#### v1 Core Tests (22 tests)

**TestGeneratePluginJson (1 test)**
- `test_generates_valid_json` - Validates plugin.json has correct structure and fields

**TestGenerateSkillMd (3 tests)**
- `test_generates_skill_with_frontmatter` - YAML frontmatter with name and description
- `test_generates_trigger_table` - Trigger table with command mappings
- `test_includes_workflow_chains` - Common workflow chains section

**TestSetupClaudePlugin (12 tests)**
- `test_creates_plugin_directory_structure` - Creates commands/, skills/, .claude-plugin/
- `test_generates_plugin_json` - Generates valid plugin manifest
- `test_creates_symlinks_for_shortcuts` - Strips shortcut: prefix from names
- `test_symlinks_are_relative` - Symlinks use relative paths
- `test_generates_skill_md` - Generates SKILL.md routing skill
- `test_include_pattern_filters_shortcuts` - Include patterns work
- `test_exclude_pattern_filters_shortcuts` - Exclude patterns work
- `test_skips_existing_symlinks_without_force` - Respects existing symlinks
- `test_overwrites_with_force` - Force flag overwrites existing
- `test_collects_from_agent_setup` - Collects from agent-setup directory
- `test_project_shortcuts_override_general` - Project shortcuts take precedence
- `test_warns_when_no_shortcuts` - Warns and skips when no shortcuts found

**TestRemoveClaudePlugin (4 tests)**
- `test_removes_plugin_directory` - Removes entire plugin directory
- `test_cleans_up_empty_parent_directories` - Cleans up empty .claude/plugins/
- `test_preserves_other_plugins` - Does not remove other plugins
- `test_no_error_if_plugin_missing` - No error if plugin doesn't exist

**TestInstallWithClaudePlugin (1 test)**
- `test_creates_claude_plugin` - Integration test for install command

**TestUninstallWithClaudePlugin (1 test)**
- `test_removes_claude_plugin` - Integration test for uninstall command

#### v1.1 Enhancement Tests (13 tests)

**TestGetPluginVersion (1 test)**
- `test_returns_version_string` - Returns version string from package metadata

**TestGeneratePluginReadme (3 tests)**
- `test_generates_readme_with_command_count` - README contains correct command count
- `test_includes_workflow_chains` - README includes workflow examples
- `test_includes_source_info` - README mentions source location

**TestGenerateHooksJson (3 tests)**
- `test_generates_valid_json` - Generates valid JSON structure
- `test_includes_session_start_by_default` - SessionStart hook included by default
- `test_can_exclude_session_start` - Can disable SessionStart hook

**TestPluginReadmeGeneration (1 test)**
- `test_generates_readme_in_plugin` - README.md created in plugin directory

**TestPluginHooksGeneration (2 tests)**
- `test_generates_hooks_by_default` - hooks.json generated by default
- `test_can_skip_hooks` - Can skip hooks generation with flag

**TestPluginReferenceSymlinks (2 tests)**
- `test_creates_reference_symlinks` - Creates symlinks to agent-rules
- `test_reference_symlinks_are_relative` - Reference symlinks use relative paths

**TestTokenBudgetDocs (1 test)**
- `test_skill_md_includes_token_budget` - SKILL.md contains token budget section

#### v2 Enhancement Tests (7 tests)

**TestGlobalPluginSetup (2 tests)**
- `test_creates_global_plugin_structure` - Creates ~/.claude/plugins/speculate/
- `test_global_readme_mentions_no_commands` - Global README has setup instructions

**TestGlobalPluginRemoval (2 tests)**
- `test_removes_global_plugin` - Removes global plugin directory
- `test_no_error_if_global_plugin_missing` - No error if not installed

**TestGlobalInstallFlag (2 tests)**
- `test_global_install_creates_plugin` - install --global creates global plugin
- `test_global_install_skips_project_setup` - Global install doesn't create project files

**TestGlobalUninstallFlag (1 test)**
- `test_global_uninstall_removes_plugin` - uninstall --global removes global plugin

### Integration and End-to-End Testing

Integration tests are included in the test suite above. Due to build environment
limitations (shallow git clone affecting dynamic versioning), full pytest run was not
executed in the current session, but:

1. All new code passes `ruff check` linting
2. All test files are syntactically correct and importable

### Manual Testing Needed

The user should perform the following manual validation:

#### 1. Run Tests Locally

```bash
cd cli
make test  # or: uv run pytest tests/test_cli_commands.py -v
```

Verify all 42 new tests pass.

#### 2. Test Install Command

```bash
cd /path/to/project  # A project with speculate docs installed
speculate install
```

Verify output shows:
- `Generated .claude/plugins/speculate/.claude-plugin/plugin.json`
- `Generated .claude/plugins/speculate/README.md`
- `Generated .claude/plugins/speculate/skills/speculate-workflow/SKILL.md`
- `Generated .claude/plugins/speculate/hooks/hooks.json`
- `.claude/plugins/speculate/: linked N commands`
- `Linked N agent-rules to .claude/plugins/speculate/reference/`

#### 3. Verify Plugin Structure

```bash
ls -la .claude/plugins/speculate/
ls -la .claude/plugins/speculate/commands/
ls -la .claude/plugins/speculate/skills/speculate-workflow/
ls -la .claude/plugins/speculate/hooks/
ls -la .claude/plugins/speculate/reference/
cat .claude/plugins/speculate/.claude-plugin/plugin.json
cat .claude/plugins/speculate/README.md
```

Verify:
- Directory structure is correct (commands/, skills/, hooks/, reference/)
- Command symlinks exist and point to docs/general/agent-shortcuts/
- Symlinks have clean names (no `shortcut:` prefix)
- SKILL.md exists and contains trigger table with token budget section
- plugin.json has correct metadata including version matching CLI version
- README.md exists with usage instructions
- hooks.json exists with SessionStart hook
- reference/ contains symlinks to agent-rules

#### 4. Test Status Command

```bash
speculate status
```

Verify output includes:
- `.claude/plugins/speculate/ exists (N commands)`

#### 5. Test Uninstall Command

```bash
speculate uninstall --force
```

Verify:
- `.claude/plugins/speculate/` is removed
- Status shows `.claude/plugins/speculate/ not configured`

#### 6. Test Force Reinstall

```bash
speculate install
speculate install --force
```

Verify no errors and regeneration messages appear.

#### 7. Test Global Install

```bash
speculate install --global
speculate status
```

Verify:
- `~/.claude/plugins/speculate/ exists (global)` shown in status
- Global plugin has plugin.json, README.md, SKILL.md, and hooks.json

```bash
speculate uninstall --global --force
speculate status
```

Verify:
- `~/.claude/plugins/speculate/ not configured (global)` shown in status

#### 8. Verify in Claude Code (if available)

If Claude Code is installed:
1. Open the project in Claude Code
2. Type `/speculate:` and verify command autocomplete shows available commands
3. Try running `/speculate:new-plan-spec` to verify command execution

## Implementation Status (v1.1 & v2)

All planned features have been implemented:

### v1.1 Enhancements âœ… Complete

| Feature | Bead ID | Status |
|---------|---------|--------|
| Dynamic version sync | `speculate-dc9` | âœ… Implemented |
| Plugin README | `speculate-j58` | âœ… Implemented |
| Token budget docs | `speculate-35s` | âœ… Implemented |
| Tests | `speculate-xbc` | âœ… 13 tests added |

**Epic**: `speculate-nz9` âœ… Complete

### v2 Enhancements âœ… Partially Complete

| Feature | Bead ID | Status |
|---------|---------|--------|
| SessionStart hook | `speculate-qhg` | âœ… Implemented |
| Personal installation | `speculate-hr8` | âœ… Implemented (`--global` flag) |
| PostToolUse hook | `speculate-azw` | ðŸ”² Deferred to v3 |
| Cross-platform | `speculate-hos` | ðŸ”² Deferred to v3 |
| Agent-rules symlinks | `speculate-3we` | âœ… Implemented |
| Tests | `speculate-5wo` | âœ… 7 tests added |

**Epic**: `speculate-j49` âœ… Core features complete

## Real-World Testing Guide

This section provides comprehensive guidance for testing the Speculate plugin
in real-world scenarios across different agent frameworks.

### Testing in Claude Code (Primary)

Claude Code is the primary target for this plugin. Here's how to test it:

#### 1. Basic Plugin Discovery

```bash
# In a project with speculate docs installed
speculate install --force

# Open Claude Code in the project directory
claude
```

**Expected**: Claude Code should recognize the plugin in `.claude/plugins/speculate/`.

#### 2. Command Autocomplete

Type `/speculate:` in Claude Code and press Tab.

**Expected**: Autocomplete should show all available commands:
- `/speculate:new-plan-spec`
- `/speculate:implement-beads`
- `/speculate:commit-code`
- etc.

#### 3. Skill-Based Triggering

Test the routing skill by asking Claude Code tasks that should trigger shortcuts:

| Test Prompt | Expected Trigger |
|-------------|------------------|
| "Help me plan a new feature for user auth" | `/speculate:new-plan-spec` |
| "I need to implement the beads from this spec" | `/speculate:implement-beads` |
| "Review my code and prepare a commit" | `/speculate:precommit-process` |
| "Create a PR for this work" | `/speculate:create-or-update-pr-with-validation-plan` |

The routing skill should announce "Using /speculate:..." before executing.

#### 4. SessionStart Hook

Start a new Claude Code session in a project with the plugin installed.

**Expected**: Should see a welcome message like:
```
Speculate workflows available. Type /speculate: to see commands.
```

### Installation Modes

There are two installation modes to test:

#### Project Installation (Default)

```bash
cd /path/to/project
speculate install
```

Creates:
- `.claude/plugins/speculate/` with symlinks to project's docs
- Commands work with project-specific shortcuts
- Reference symlinks to project's agent-rules

**Use for**: Regular project work where you want project-specific commands.

#### Global Installation

```bash
speculate install --global
```

Creates:
- `~/.claude/plugins/speculate/` (personal, cross-project)
- No commands (instructions only)
- Routing skill with guidance

**Use for**: Having the skill available across all projects, with project-specific
commands added per-project via `speculate install`.

#### Combined Usage (Recommended)

For the best experience:

1. Install globally once: `speculate install --global`
2. Install per-project as needed: `speculate install`

The project-level plugin takes precedence when both are installed.

### Cross-Platform Testing

#### Cursor

Speculate also configures Cursor via `.cursor/rules/`:

```bash
speculate install
ls -la .cursor/rules/
```

**Expected**: Symlinks with `.mdc` extension pointing to agent-rules.

Cursor users get:
- Agent rules as context
- No command autocomplete (Cursor limitation)
- Must use `@` references to invoke shortcuts

#### Codex

Codex uses `AGENTS.md`:

```bash
speculate install
cat AGENTS.md | head -20
```

**Expected**: Speculate header pointing to `docs/development.md` and `docs/docs-overview.md`.

### Efficient Usage Patterns

#### Pattern 1: Full Feature Flow

The most powerful pattern is the full spec-driven flow:

```
User: "I want to add a dark mode feature"
Claude: Using /speculate:new-plan-spec
... creates plan spec ...

User: "Create beads to implement this"
Claude: Using /speculate:new-implementation-beads-from-spec
... creates beads ...

User: "Implement the beads"
Claude: Using /speculate:implement-beads
... implements each bead ...

User: "Create a PR"
Claude: Using /speculate:create-or-update-pr-with-validation-plan
... creates PR with validation ...
```

#### Pattern 2: Quick Commit Flow

For smaller changes:

```
User: "Review and commit my changes"
Claude: Using /speculate:precommit-process
... runs checks ...
Claude: Using /speculate:commit-code
... commits with good message ...
```

#### Pattern 3: Research-First

For complex tasks:

```
User: "I need to understand how authentication works before adding OAuth"
Claude: Using /speculate:new-research-brief
... creates research brief ...

User: "Now plan the OAuth integration"
Claude: Using /speculate:new-plan-spec
... creates plan based on research ...
```

### Token Budget Considerations

The plugin adds context to Claude's prompt:

| Component | Approximate Tokens |
|-----------|-------------------|
| Routing skill (SKILL.md) | 400-500 tokens |
| Each command file | 200-500 tokens |
| Reference rules (if read) | 100-300 tokens each |

**Tips for efficiency**:
- The routing skill only loads when semantic matching triggers it
- Command files load on-demand when invoked
- Reference rules are available but not auto-loaded

### Troubleshooting

#### Commands Not Appearing

```bash
# Verify plugin structure
ls -la .claude/plugins/speculate/
ls -la .claude/plugins/speculate/commands/

# Regenerate if needed
speculate install --force
```

#### Symlinks Broken

```bash
# Check symlink targets
ls -la .claude/plugins/speculate/commands/ | head -5

# Should show relative paths like:
# command.md -> ../../../../docs/general/agent-shortcuts/shortcut:command.md
```

#### Skill Not Triggering

Verify SKILL.md contains:
- YAML frontmatter with `name:` and `description:`
- Trigger table with commands

```bash
cat .claude/plugins/speculate/skills/speculate-workflow/SKILL.md | head -20
```

## Open Questions

1. **Full test suite**: Can the user run `make test` successfully in the CLI directory?
   The development environment may need `git fetch --unshallow` for dynamic versioning.

2. **Claude Code plugin loading**: Does Claude Code correctly load plugins from
   `.claude/plugins/` with symlinked commands? This needs manual verification.

3. **PostToolUse hook**: Should auto-formatting hooks be added in a future version?
   Requires more research on best practices and user preferences.

4. **Cross-platform Cursor rules**: Should shortcuts be converted to Cursor rules?
   This has significant complexity and may not be needed if teams use Claude Code.

---

## Appendix: Beads Comparison and Recommendations

### How Beads Implements Hooks

Beads (`github.com/steveyegge/beads`) is an AI-supervised issue tracker with sophisticated
Claude Code integration. Their approach offers lessons for Speculate:

#### Beads Hook Architecture

```
.claude/settings.json:
{
  "hooks": {
    "SessionStart": [{ "matcher": "", "hooks": [{
      "type": "command",
      "command": "bash ~/.claude/hooks/session-start.sh"
    }]}]
  }
}
```

The session-start.sh script runs `bd prime` which outputs rich contextual markdown:

```markdown
# Beads Workflow Context

> **Context Recovery**: Run `bd prime` after compaction, clear, or new session

# ðŸš¨ SESSION CLOSE PROTOCOL ðŸš¨

**CRITICAL**: Before saying "done" or "complete", you MUST run this checklist:

[ ] 1. git status              (check what changed)
[ ] 2. git add <files>         (stage code changes)
[ ] 3. bd sync                 (commit beads changes)
[ ] 4. git commit -m "..."     (commit code)
[ ] 5. bd sync                 (commit any new beads changes)
[ ] 6. git push                (push to remote)

**NEVER skip this.** Work is not done until pushed.

## Core Rules
- Track strategic work in beads (multi-session, dependencies, discovered work)
- Use `bd create` for issues, TodoWrite for simple single-session execution
...
```

#### Key Beads Patterns

| Pattern | Beads Implementation | Speculate Equivalent |
|---------|---------------------|---------------------|
| Rich SessionStart | `bd prime` outputs ~1-2k tokens of context | Simple echo message (~50 tokens) |
| Session Close Protocol | Mandatory checklist before "done" | Not implemented |
| Adaptive Output | Different output for MCP vs CLI mode | Single static message |
| Custom Override | `.beads/PRIME.md` replaces default | Not implemented |
| Git Integration | pre-commit, post-merge, pre-push hooks | Not implemented |

### Recommendations for v3

Based on Beads patterns, consider these enhancements for Speculate:

#### 1. Rich SessionStart Context

**Current:**
```json
{
  "hooks": {
    "SessionStart": [{
      "matcher": "*",
      "hooks": [{
        "type": "command",
        "command": "echo 'Speculate workflows available. Type /speculate: to see commands.'"
      }]
    }]
  }
}
```

**Proposed (`speculate prime` command):**
```bash
# SessionStart hook calls:
speculate prime
```

Output would include:
- Available workflow commands
- Current project state (uncommitted changes, active specs, open beads)
- Session close protocol reminder
- Token budget: ~500-800 tokens

#### 2. Session Close Protocol

Add to SKILL.md or prime output:

```markdown
# ðŸš¨ SESSION CLOSE PROTOCOL ðŸš¨

Before saying "done", run this checklist:

[ ] 1. /speculate:precommit-process  (run checks)
[ ] 2. /speculate:commit-code        (commit changes)
[ ] 3. /speculate:create-or-update-pr-with-validation-plan  (if PR needed)
[ ] 4. git push                      (push to remote)

Work is not done until pushed.
```

#### 3. Adaptive Context

The `speculate prime` command could output different context based on:
- Are there uncommitted changes? â†’ Remind about commit flow
- Is there an active spec? â†’ Show spec status
- Are there open beads? â†’ List ready work
- Is this a feature branch? â†’ Remind about PR creation

#### 4. Custom Override

Support `.speculate/PRIME.md` to override default session context.

### Implementation Priority

| Enhancement | Effort | Value | Priority |
|-------------|--------|-------|----------|
| `speculate prime` command | Medium | High | v3 |
| Session close protocol | Low | High | v3 |
| Adaptive context | High | Medium | v4 |
| Custom override | Low | Low | v4 |

### Key Insight

The fundamental difference between current Speculate and Beads:

- **Speculate**: Plugin with commands + simple welcome message
- **Beads**: Plugin with rich contextual priming that shapes agent behavior

Beads' approach is more prescriptiveâ€”it injects workflow protocols that the agent
must follow. Speculate's approach is more opt-inâ€”workflows are available but not
enforced.

Both approaches have merit. For teams wanting more structure, adding a `speculate prime`
command similar to `bd prime` would provide that capability while keeping the current
lightweight approach as the default.
